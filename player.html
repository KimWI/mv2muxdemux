<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MSX2 MV2 Universal Web Player (Overlay EQ Edition)</title>
    <style>
        body { background-color: #111; color: #eee; font-family: sans-serif; text-align: center; margin-top: 30px; }
        
        /* ğŸ’¡ ì¶”ê°€: ìº”ë²„ìŠ¤ì™€ ì˜¤ë²„ë ˆì´ë¥¼ ê°ì‹¸ëŠ” ë˜í¼ */
        #screen-wrapper {
            position: relative;
            display: inline-block;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            border: 4px solid #333;
            background-color: #000;
        }

        #msx-screen {
            width: 768px;
            height: 576px;
            image-rendering: pixelated;
            display: block; /* ë˜í¼ ë‚´ë¶€ì—ì„œ ì—¬ë°± ì œê±° */
            transition: width 0.2s, height 0.2s; 
        }

        /* ğŸ’¡ ì¶”ê°€: 1/16 ì‚¬ì´ì¦ˆ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ (ê°€ë¡œ 25%, ì„¸ë¡œ 25%) */
	#eq-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 25%;
            height: 25%;
            background-color: transparent; /* ğŸ’¡ ì—¬ê¸°ë¥¼ transparentë¡œ ë³€ê²½ */
            pointer-events: none; 
            display: none; 
            align-items: flex-end;
            justify-content: space-between;
            padding: 2%; 
            box-sizing: border-box;
            gap: 2px;
            z-index: 10;
        }

	.overlay-eq-bar {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.2); /* ğŸ’¡ ì—¬ê¸°ë¥¼ rgbaë¡œ ë³€ê²½ */
            height: 0%;
            border-radius: 2px 2px 0 0;
            transition: height 0.05s ease-out;
        }
        
        .controls { margin-top: 20px; display: flex; justify-content: center; gap: 15px; align-items: center; flex-wrap: wrap; }
        button, input[type="file"] { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #333; color: white; border: 1px solid #555; border-radius: 4px; }
        button:hover { background: #555; }
        button:disabled { background: #222; color: #666; cursor: not-allowed; }
        
        .panel { background: #222; padding: 10px 20px; border-radius: 8px; border: 1px solid #444; display: flex; align-items: center; gap: 10px; }
        
        #status { margin-top: 15px; font-weight: bold; color: #4CAF50; }
        #debug-info { margin-top: 5px; font-size: 12px; color: #aaa; }

        #dashboard { 
            display: none; 
            justify-content: center; 
            gap: 40px; 
            margin-top: 20px; 
            padding: 15px; 
            background: #1a1a1a; 
            border: 1px solid #333;
            border-radius: 8px;
            width: fit-content;
            margin-left: auto; margin-right: auto;
        }
        .dash-section { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .dash-title { font-size: 12px; color: #888; letter-spacing: 1px; }
        
        #vis-palette { display: flex; gap: 2px; }
        .pal-box { width: 24px; height: 24px; border: 1px solid #555; border-radius: 2px; }
        
        #vis-eq { 
            display: flex; gap: 3px; align-items: flex-end; 
            height: 60px; border-bottom: 2px solid #555; padding-bottom: 2px; 
            width: 280px; justify-content: center;
        }
        .eq-bar { width: 12px; background-color: #00ffcc; border-radius: 2px 2px 0 0; transition: height 0.05s ease-out; }
        .eq-center-divider { width: 2px; height: 10px; background-color: #666; margin: 0 4px; }
    </style>
</head>
<body>

    <h2>MSX2 Universal Player (SCREEN 2)</h2>
    
    <div id="screen-wrapper">
        <canvas id="msx-screen" width="256" height="192"></canvas>
        <div id="eq-overlay">
            <div class="overlay-eq-bar"></div><div class="overlay-eq-bar"></div>
            <div class="overlay-eq-bar"></div><div class="overlay-eq-bar"></div>
            <div class="overlay-eq-bar"></div><div class="overlay-eq-bar"></div>
            <div class="overlay-eq-bar"></div><div class="overlay-eq-bar"></div>
            <div class="overlay-eq-bar"></div>
        </div>
    </div>
    
    <div class="controls">
        <input type="file" id="file-input" accept=".mv1,.mv2" />
        <button id="btn-play" disabled>â–¶ Play</button>
        <button id="btn-pause" disabled>â¸ Pause</button>
        
        <div class="panel">
            <label for="scale-slider">ğŸ“º Size: <span id="scale-label">3x</span></label>
            <input type="range" id="scale-slider" min="3" max="5" step="1" value="3">
        </div>
        
        <div class="panel">
            <label style="cursor: pointer;">
                <input type="checkbox" id="toggle-dashboard"> ğŸ“Š Dash View
            </label>
        </div>

        <div class="panel">
            <button id="toggle-overlay-btn" style="padding: 5px 10px; font-size: 14px;">Overlay ON</button>
            <label for="overlay-opacity" style="margin-left: 10px; font-size: 14px;">Opacity: <span id="opacity-label">20%</span></label>
            <input type="range" id="overlay-opacity" min="0" max="1" step="0.05" value="0.2" style="width: 80px;">
        </div>
    </div>
    
    <div id="status">ëŒ€ê¸° ì¤‘... MV1 ë˜ëŠ” MV2 íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>
    <div id="debug-info"></div>

    <div id="dashboard">
        <div class="dash-section">
            <div class="dash-title">PALETTE MEMORY (16 COLORS)</div>
            <div id="vis-palette"></div>
        </div>
        <div class="dash-section">
            <div class="dash-title">STEREO EQ SPECTRUM (18 BANDS)</div>
            <div id="vis-eq"></div>
        </div>
    </div>

<script>
class MSXMediaDemuxer {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        this.ctx = this.canvas.getContext('2d');
        this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        this.frames = [];
        this.audioSource = null;
        this.isPlaying = false;
        this.startTime = 0;
        this.pauseTime = 0;
        this.animationId = null;
        
        this.format = null;
        this.fps = 0;
        this.totalFrames = 0;
        
        this.initDashboard();
    }

    initDashboard() {
        const palContainer = document.getElementById('vis-palette');
        for (let i = 0; i < 16; i++) {
            const d = document.createElement('div');
            d.className = 'pal-box';
            palContainer.appendChild(d);
        }
        
        const eqContainer = document.getElementById('vis-eq');
        
        for (let i = 0; i < 9; i++) {
            const d = document.createElement('div');
            d.className = 'eq-bar';
            d.style.height = '0px';
            eqContainer.appendChild(d);
        }
        
        const divider = document.createElement('div');
        divider.className = 'eq-center-divider';
        eqContainer.appendChild(divider);

        for (let i = 0; i < 9; i++) {
            const d = document.createElement('div');
            d.className = 'eq-bar';
            d.style.height = '0px';
            eqContainer.appendChild(d);
        }
    }

    reset() {
        this.isPlaying = false;
        cancelAnimationFrame(this.animationId);

        if (this.audioSource) {
            try { this.audioSource.stop(); } catch (e) {}
            this.audioSource.disconnect();
            this.audioSource = null;
        }

        this.frames = [];
        this.audioBuffer = null;
        this.totalFrames = 0;
        this.startTime = 0;
        this.pauseTime = 0;

        this.ctx.fillStyle = "black";
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

        document.getElementById('btn-play').disabled = true;
        document.getElementById('btn-pause').disabled = true;
        
        const eqDivs = document.getElementById('vis-eq').children;
        for(let i=0; i<eqDivs.length; i++) {
            if(eqDivs[i].className === 'eq-bar') eqDivs[i].style.height = '0px';
        }

        // ì˜¤ë²„ë ˆì´ ë¦¬ì…‹
        const overlayBars = document.getElementById('eq-overlay').children;
        for(let i=0; i<overlayBars.length; i++) {
            overlayBars[i].style.height = '0%';
        }
    }

    async loadFile(file) {
        this.reset(); 
        document.getElementById('status').innerText = "íŒŒì¼ ë¶„ì„ ì¤‘...";
        
        const arrayBuffer = await file.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        
        const sigText = String.fromCharCode(...data.slice(0, 8));
        const versionText = String.fromCharCode(...data.slice(16, 21));
        
        const hexDump = Array.from(data.slice(0, 8)).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        document.getElementById('debug-info').innerText = `Header Hex: [${hexDump}] | Sig: [${sigText}] | Ver: [${versionText}]`;

        try {
            if (sigText === "MMCSD_MV") {
                if (versionText === "v1.00") {
                    this.format = "MV1 (Official)";
                    this.fps = 12;
                    await this.parseMV1(data);
                } else if (versionText === "v2.00") {
                    this.format = "MV2 (Official)";
                    this.fps = 15;
                    await this.parseMV2(data, 16384); 
                } else {
                    throw new Error(`ì•Œ ìˆ˜ ì—†ëŠ” ê³µì‹ ë²„ì „ì…ë‹ˆë‹¤: ${versionText}`);
                }
            } 
            else if (sigText.startsWith("MV2")) {
                this.format = "MV2 (Legacy 512B)";
                this.fps = 15;
                await this.parseMV2(data, 512); 
            } 
            else {
                throw new Error(`ì§€ì›í•˜ì§€ ì•ŠëŠ” í¬ë§·ì…ë‹ˆë‹¤. (Sig: ${sigText})`);
            }
            
            document.getElementById('status').innerText = `[${this.format}] íŒŒì‹± ì™„ë£Œ! (${this.fps} FPS, ${this.totalFrames} í”„ë ˆì„)`;
            document.getElementById('btn-play').disabled = false;
        } catch (err) {
            document.getElementById('status').innerText = `ì—ëŸ¬: ${err.message}`;
            document.getElementById('status').style.color = "#ff4444";
            console.error(err);
        }
    }

    async parseMV1(data) {
        this.frames = [];
        let offset = 16384; 
        let pcmChunks = [];

        while (offset + 16384 <= data.length) {
            const pgt = data.slice(offset, offset + 6144);
            const ct = data.slice(offset + 6144, offset + 12288);
            const pcm = data.slice(offset + 12288, offset + 13232);
            
            const palRaw = data.slice(offset + 13232, offset + 13262); 
            const palette = [[0, 0, 0]].concat(this.extractPalette(palRaw, 15));
            const eqRaw = new Uint8Array(10); 

            this.frames.push({ pgt, ct, palette, eqRaw });
            pcmChunks.push(pcm);
            offset += 16384;
        }
        this.totalFrames = this.frames.length;

        const sampleRate = 944 * 12; 
        const audioBuffer = this.audioCtx.createBuffer(1, this.totalFrames * 944, sampleRate);
        const channelData = audioBuffer.getChannelData(0);
        
        let writeOffset = 0;
        for (let i = 0; i < pcmChunks.length; i++) {
            for (let j = 0; j < 944; j++) {
                channelData[writeOffset++] = (pcmChunks[i][j] - 128) / 128.0;
            }
        }
        this.audioBuffer = audioBuffer;
    }

    async parseMV2(data, headerSize) {
        this.frames = [];
        let offset = headerSize; 
        let mp3Chunks = [];
        let isLegacy = (headerSize === 512);

        while (offset < data.length) {
            const blockSize = isLegacy ? 15872 : 16384;
            if (offset + blockSize > data.length) break;

            const pgt = data.slice(offset, offset + 6144);
            const ct = data.slice(offset + 6144, offset + 12288);
            
            const palRaw = data.slice(offset + 12288, offset + 12318);
            const palette = [[0, 0, 0]].concat(this.extractPalette(palRaw, 15));
            
            const eqRaw = data.slice(offset + 12320, offset + 12330);
            
            const sz = data[offset + 12800];
            const mp3Data = data.slice(offset + 12801, offset + 12801 + (sz * 32));
            
            this.frames.push({ pgt, ct, palette, eqRaw });
            mp3Chunks.push(mp3Data);

            offset += blockSize;
            isLegacy = false; 
        }
        this.totalFrames = this.frames.length;

        const totalMp3Length = mp3Chunks.reduce((acc, chunk) => acc + chunk.length, 0);
        const mp3Concat = new Uint8Array(totalMp3Length);
        let writeOffset = 0;
        for (let chunk of mp3Chunks) {
            mp3Concat.set(chunk, writeOffset);
            writeOffset += chunk.length;
        }
        this.audioBuffer = await this.audioCtx.decodeAudioData(mp3Concat.buffer);
    }

    extractPalette(palData, colorCount) {
        const pal = [];
        for (let i = 0; i < colorCount; i++) {
            if (i * 2 + 1 >= palData.length) break;
            const r_b = palData[i * 2];     
            const g = palData[i * 2 + 1];   
            
            const r8 = Math.round(((r_b >> 4) & 0x07) * 255 / 7);
            const b8 = Math.round((r_b & 0x07) * 255 / 7);
            const g8 = Math.round((g & 0x07) * 255 / 7);
            pal.push([r8, g8, b8]);
        }
        while (pal.length < colorCount) pal.push([0, 0, 0]);
        return pal;
    }

    renderFrame(frameIndex) {
        if (frameIndex >= this.totalFrames) return;
        const frame = this.frames[frameIndex];
        const imgData = this.ctx.createImageData(256, 192);
        const data = imgData.data;

        for (let y = 0; y < 192; y++) {
            for (let cx = 0; cx < 32; cx++) {
                const off = (Math.floor(y / 8) * 32 + cx) * 8 + (y % 8);
                const p_byte = frame.pgt[off];
                const c_byte = frame.ct[off];
                
                const fg = (c_byte >> 4) & 0x0F;
                const bg = c_byte & 0x0F;

                const x_start = cx * 8;
                for (let p = 0; p < 8; p++) {
                    const colorIdx = (p_byte & (1 << (7 - p))) !== 0 ? fg : bg;
                    const rgb = frame.palette[colorIdx] || [0, 0, 0];
                    
                    const pxOffset = (y * 256 + (x_start + p)) * 4;
                    data[pxOffset] = rgb[0];
                    data[pxOffset + 1] = rgb[1];
                    data[pxOffset + 2] = rgb[2];
                    data[pxOffset + 3] = 255;
                }
            }
        }
        this.ctx.putImageData(imgData, 0, 0);

        // í•˜ë‹¨ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        if (document.getElementById('toggle-dashboard').checked) {
            const palDivs = document.getElementById('vis-palette').children;
            for(let i = 0; i < 16; i++) {
                const rgb = frame.palette[i] || [0, 0, 0];
                palDivs[i].style.backgroundColor = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
            }
            
            const eqDivs = document.getElementById('vis-eq').children;
            for(let i = 0; i < 9; i++) {
                const rawVal = frame.eqRaw[i] !== undefined ? frame.eqRaw[i] : 15;
                const realVal = 15 - Math.min(rawVal, 15); 
                const heightPx = (realVal / 15.0) * 60; 
                
                eqDivs[i].style.height = `${heightPx}px`;
                eqDivs[18 - i].style.height = `${heightPx}px`;
            }
        }

        // ğŸ’¡ ì¶”ê°€: ì˜¤ë²„ë ˆì´ EQ ì—…ë°ì´íŠ¸
        const eqOverlay = document.getElementById('eq-overlay');
        if (eqOverlay.style.display !== 'none') {
            const overlayBars = eqOverlay.children;
            for(let i = 0; i < 9; i++) {
                const rawVal = frame.eqRaw[i] !== undefined ? frame.eqRaw[i] : 15;
                const realVal = 15 - Math.min(rawVal, 15); 
                
                // ì˜¤ë²„ë ˆì´ëŠ” í”½ì…€(px)ì´ ì•„ë‹Œ í¼ì„¼íŠ¸(%)ë¡œ ë†’ì´ë¥¼ ì„¤ì •í•˜ì—¬ í•´ìƒë„ ë¹„ìœ¨ì— ìœ ì—°í•˜ê²Œ ëŒ€ì‘í•©ë‹ˆë‹¤.
                const heightPct = (realVal / 15.0) * 100; 
                overlayBars[i].style.height = `${heightPct}%`;
            }
        }
    }

    play() {
        if (this.isPlaying) return;
        if (this.audioCtx.state === 'suspended') this.audioCtx.resume();

        this.audioSource = this.audioCtx.createBufferSource();
        this.audioSource.buffer = this.audioBuffer;
        this.audioSource.connect(this.audioCtx.destination);
        
        this.audioSource.start(0, this.pauseTime);
        this.startTime = this.audioCtx.currentTime - this.pauseTime;
        this.isPlaying = true;

        document.getElementById('btn-play').disabled = true;
        document.getElementById('btn-pause').disabled = false;

        const loop = () => {
            if (!this.isPlaying) return;
            
            const currentTime = this.audioCtx.currentTime - this.startTime;
            const currentFrame = Math.floor(currentTime * this.fps);
            
            if (currentFrame < this.totalFrames) {
                this.renderFrame(currentFrame);
                this.animationId = requestAnimationFrame(loop);
            } else {
                this.pause(); 
            }
        };
        loop();
    }

    pause() {
        if (!this.isPlaying) return;
        this.isPlaying = false;
        
        if (this.audioSource) {
            this.audioSource.stop();
        }
        
        this.pauseTime = this.audioCtx.currentTime - this.startTime;
        cancelAnimationFrame(this.animationId);

        document.getElementById('btn-play').disabled = false;
        document.getElementById('btn-pause').disabled = true;
    }
}

const player = new MSXMediaDemuxer('msx-screen');

document.getElementById('file-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('status').style.color = "#4CAF50"; 
    await player.loadFile(file);
});

document.getElementById('btn-play').addEventListener('click', () => player.play());
document.getElementById('btn-pause').addEventListener('click', () => player.pause());

document.getElementById('scale-slider').addEventListener('input', (e) => {
    const scale = parseInt(e.target.value, 10);
    const canvas = document.getElementById('msx-screen');
    document.getElementById('scale-label').innerText = `${scale}x`;
    
    canvas.style.width = `${256 * scale}px`;
    canvas.style.height = `${192 * scale}px`;
});

document.getElementById('toggle-dashboard').addEventListener('change', (e) => {
    const dash = document.getElementById('dashboard');
    dash.style.display = e.target.checked ? 'flex' : 'none';
});

// ğŸ’¡ ì¶”ê°€: ì˜¤ë²„ë ˆì´ í† ê¸€ ë° íˆ¬ëª…ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.getElementById('toggle-overlay-btn').addEventListener('click', (e) => {
    const overlay = document.getElementById('eq-overlay');
    if (overlay.style.display === 'none') {
        overlay.style.display = 'flex';
        e.target.innerText = 'Overlay OFF';
        e.target.style.backgroundColor = '#d9534f'; // ì¼œì¡Œì„ ë•Œ ë¶‰ì€ í†¤ìœ¼ë¡œ ë³€ê²½
    } else {
        overlay.style.display = 'none';
        e.target.innerText = 'Overlay ON';
        e.target.style.backgroundColor = '#333';
    }
});

document.getElementById('overlay-opacity').addEventListener('input', (e) => {
    const alpha = e.target.value;
    document.getElementById('opacity-label').innerText = `${Math.round(alpha * 100)}%`;
    const overlayBars = document.getElementsByClassName('overlay-eq-bar');
    for(let i = 0; i < overlayBars.length; i++) {
        overlayBars[i].style.backgroundColor = `rgba(255, 255, 255, ${alpha})`;
    }
});

</script>
</body>
</html>
