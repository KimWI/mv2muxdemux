<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MSX MV2 Web Demuxer (MP3 / ALAC Selection)</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #1e1e1e; color: #fff; padding: 40px; max-width: 1200px; margin: 0 auto; text-align: center; }
        .box { background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-align: left; }
        
        button { color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 15px; margin: 5px; transition: background 0.2s; }
        button:disabled { background: #555 !important; cursor: not-allowed; }
        
        .btn-primary { background: #0078D7; }
        .btn-play { background: #E50914; }
        .btn-down { background: #28a745; text-decoration: none; display: inline-block; }

        pre { background: #000; padding: 15px; border-radius: 4px; overflow-y: auto; max-height: 200px; color: #00ff00; font-family: monospace; }
        #playerArea { margin-top: 30px; display: none; }
        
        .player-wrapper {
            position: relative;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8); 
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            padding: 10px;
        }

        #videoPlayer { 
            display: block;
            transition: width 0.3s ease, height 0.3s ease; 
            image-rendering: pixelated; 
        }

        .scale-btn { background: #444; font-size: 13px; padding: 6px 12px; }
        
        #resultActions {
            display: none; 
            margin-top: 20px;
            padding: 15px;
            background: #333;
            border-radius: 8px;
        }
        .action-group { margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
    </style>
    
    <script src="coi-serviceworker.js"></script>
    <script src="ffmpeg.js"></script>
</head>
<body>

    <h1>üé¨ MSX MV2 Web Demuxer (MP3 / ALAC Selection)</h1>
    
    <div class="box">
        <input type="file" id="mv2file" accept=".MV2,.mv2" />
        <br><br>
        <button id="startBtn" class="btn-primary">‚ñ∂ Î≥ÄÌôò Î∞è Ïù∏ÏΩîÎî© ÏãúÏûë</button>
    </div>

    <div id="resultActions">
        <div class="action-group">
            <h3>üéµ Option 1. MP4 (Original MP3 Audio)</h3>
            <button id="playMp3Vid" class="btn-play">üé¨ MP3 Î≤ÑÏ†Ñ Ïû¨ÏÉù</button>
            <a id="downMp3Vid" class="btn-down">‚Üì MP3 Î≤ÑÏ†Ñ Ï†ÄÏû•</a>
        </div>
        
        <div class="action-group" style="border:none;">
            <h3>üéß Option 2. M4A/MP4 (Lossless ALAC Audio)</h3>
            <button id="playAlacVid" class="btn-play">üé¨ ALAC Î≤ÑÏ†Ñ Ïû¨ÏÉù</button>
            <a id="downAlacVid" class="btn-down">‚Üì ALAC Î≤ÑÏ†Ñ Ï†ÄÏû•</a>
        </div>
    </div>

    <div id="playerArea">
        <div id="scaleControls">
            <button class="scale-btn" id="btn1x">1x</button>
            <button class="scale-btn" id="btn2x">2x</button>
            <button class="scale-btn" id="btn4x">4x</button>
        </div>
        <div class="player-wrapper">
            <video id="videoPlayer" controls playsinline></video>
        </div>
    </div>

    <div class="box" style="margin-top: 30px;">
        <h3>ÏßÑÌñâ ÏÉÅÌô© Î°úÍ∑∏</h3>
        <pre id="log">ÎåÄÍ∏∞ Ï§ë...</pre>
    </div>

    <canvas id="renderCanvas" width="256" height="192" style="display:none;"></canvas>

    <script>
        const { FFmpeg } = FFmpegWASM;
        const ffmpeg = new FFmpeg();
        
        const logEl = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const resultActions = document.getElementById('resultActions');
        const playerArea = document.getElementById('playerArea');
        const videoPlayer = document.getElementById('videoPlayer');
        const renderCanvas = document.getElementById('renderCanvas');
        const ctx = renderCanvas.getContext('2d', { willReadFrequently: true });

        let videoUrls = { mp3: null, alac: null };

        document.getElementById('btn1x').addEventListener('click', () => setPlayerSize(256, 192));
        document.getElementById('btn2x').addEventListener('click', () => setPlayerSize(512, 384));
        document.getElementById('btn4x').addEventListener('click', () => setPlayerSize(1024, 768));

        function setPlayerSize(w, h) {
            videoPlayer.style.width = w + 'px';
            videoPlayer.style.height = h + 'px';
        }

        function log(msg) {
            logEl.textContent += `\n[System] ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        ffmpeg.on('log', ({ message }) => {
            logEl.textContent += `\n[FFmpeg] ${message}`;
            logEl.scrollTop = logEl.scrollHeight;
        });

        function rgb333_to_888(r, g, b) {
            return [Math.floor(r * 255 / 7), Math.floor(g * 255 / 7), Math.floor(b * 255 / 7)];
        }

        async function demuxMV2(arrayBuffer) {
            const data = new Uint8Array(arrayBuffer);
            const blockSize = 16384;
            let pos = 16384;
            const frames = [];
            let audioChunks = [];
            let palette = Array(16).fill([0, 0, 0]);

            while (pos < data.length) {
                let block = data.subarray(pos, pos + 16384);
                pos += 16384;
                if (block.length < 12318) break;

                for (let i = 0; i < 15; i++) {
                    let b1 = block[12288 + i * 2], b2 = block[12288 + i * 2 + 1];
                    palette[i + 1] = rgb333_to_888((b1 >> 4) & 0x07, b1 & 0x07, b2 & 0x07);
                }

                let pixels = new Uint8Array(256 * 192 * 3);
                let pOff = 0;
                for (let y = 0; y < 192; y++) {
                    for (let x = 0; x < 256; x++) {
                        let off = (Math.floor(y / 8) * 32 + Math.floor(x / 8)) * 8 + (y % 8);
                        let isFg = (block[off] & (1 << (7 - (x % 8)))) !== 0;
                        let color = isFg ? palette[block[6144 + off] >> 4] : palette[block[6144 + off] & 0x0F];
                        pixels[pOff++] = color[0]; pixels[pOff++] = color[1]; pixels[pOff++] = color[2];
                    }
                }

                let eq = new Uint8Array(9);
                for(let i=0; i<9; i++) eq[i] = 15 - Math.min(block[12320 + i], 15);
                frames.push({ pixels, eq });

                if (block[12800] > 0) audioChunks.push(block.slice(12801, 12801 + block[12800] * 32));
            }
            const audioBuffer = new Uint8Array(audioChunks.reduce((a, c) => a + c.length, 0));
            let aOff = 0;
            audioChunks.forEach(c => { audioBuffer.set(c, aOff); aOff += c.length; });
            return { frames, audioBuffer };
        }

        function generateVideoWithEQ(frames) {
            const buffer = new Uint8Array(frames.length * 256 * 192 * 3);
            frames.forEach((f, i) => {
                const img = ctx.createImageData(256, 192);
                for (let j=0, k=0; j < f.pixels.length; j+=3) {
                    img.data[k++] = f.pixels[j]; img.data[k++] = f.pixels[j+1]; img.data[k++] = f.pixels[j+2]; img.data[k++] = 255;
                }
                ctx.putImageData(img, 0, 0);
                
                // üí° Ìà¨Î™ÖÎèÑ 20% Î∞±ÏÉâ ÎßâÎåÄÍ∏∞ Ïò§Î≤ÑÎ†àÏù¥
                ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
                f.eq.forEach((v, b) => {
                    const h = (v / 15) * 43;
                    ctx.fillRect(2 + b * 7, 48 - h + 2, 6, Math.max(1, h));
                });

                const comp = ctx.getImageData(0, 0, 256, 192).data;
                for (let j=0, k=0; j < comp.length; j+=4) {
                    buffer[i * 147456 + k++] = comp[j]; buffer[i * 147456 + k++] = comp[j+1]; buffer[i * 147456 + k++] = comp[j+2];
                }
            });
            return buffer;
        }

        startBtn.addEventListener('click', async () => {
            const file = document.getElementById('mv2file').files[0];
            if (!file) return alert("ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
            startBtn.disabled = true;
            log("Î≥ÄÌôò Î∞è Ìï©ÏÑ± ÏãúÏûë...");

            try {
                const { frames, audioBuffer } = await demuxMV2(await file.arrayBuffer());
                const videoBuffer = generateVideoWithEQ(frames);

                // Î°úÏª¨ ÏΩîÏñ¥ ÌååÏùº Î°úÎî© (GitHub PagesÏö©)
                if (!ffmpeg.loaded) await ffmpeg.load({ coreURL: 'ffmpeg-core.js', wasmURL: 'ffmpeg-core.wasm' });
                
                await ffmpeg.writeFile('video.raw', videoBuffer);
                await ffmpeg.writeFile('audio.mp3', audioBuffer);

                log("Option 1. MP3 Î≤ÑÏ†Ñ ÏÉùÏÑ± Ï§ë...");
                await ffmpeg.exec(['-y', '-f', 'rawvideo', '-pix_fmt', 'rgb24', '-s', '256x192', '-r', '15', '-i', 'video.raw', '-i', 'audio.mp3', '-c:v', 'libx264', '-pix_fmt', 'yuv420p', '-c:a', 'copy', '-shortest', 'mp3_ver.mp4']);
                const d1 = await ffmpeg.readFile('mp3_ver.mp4');
                videoUrls.mp3 = URL.createObjectURL(new Blob([d1.buffer], { type: 'video/mp4' }));

                log("Option 2. ALAC Î≤ÑÏ†Ñ ÏÉùÏÑ± Ï§ë...");
                // Ïò§ÎîîÏò§ ÏΩîÎç±Îßå ALACÏúºÎ°ú Î≥ÄÌôò
                await ffmpeg.exec(['-y', '-i', 'mp3_ver.mp4', '-c:v', 'copy', '-c:a', 'alac', 'alac_ver.mp4']);
                const d2 = await ffmpeg.readFile('alac_ver.mp4');
                videoUrls.alac = URL.createObjectURL(new Blob([d2.buffer], { type: 'video/mp4' }));

                document.getElementById('downMp3Vid').href = videoUrls.mp3;
                document.getElementById('downMp3Vid').download = file.name.replace(/\.[^/.]+$/, "") + "_mp3.mp4";
                document.getElementById('downAlacVid').href = videoUrls.alac;
                document.getElementById('downAlacVid').download = file.name.replace(/\.[^/.]+$/, "") + "_alac.mp4";

                resultActions.style.display = "block";
                log("‚úÖ Î™®Îì† Ïù∏ÏΩîÎî© ÏôÑÎ£å!");
            } catch (e) { log(`Error: ${e.message}`); }
            startBtn.disabled = false;
        });

        document.getElementById('playMp3Vid').addEventListener('click', () => { playerArea.style.display="block"; videoPlayer.src=videoUrls.mp3; videoPlayer.play(); });
        document.getElementById('playAlacVid').addEventListener('click', () => { playerArea.style.display="block"; videoPlayer.src=videoUrls.alac; videoPlayer.play(); });
    </script>
</body>
</html>
