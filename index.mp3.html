<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MSX MV2 to MP4 (ALAC & EQ Overlay) Web Demuxer</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #1e1e1e; color: #fff; padding: 40px; max-width: 1200px; margin: 0 auto; text-align: center; }
        .box { background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-align: left; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¸ë¶„í™” */
        button { color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 15px; margin: 5px; transition: background 0.2s; }
        button:disabled { background: #555 !important; cursor: not-allowed; }
        
        .btn-primary { background: #0078D7; }
        .btn-primary:hover { background: #005a9e; }
        
        .btn-play { background: #E50914; }
        .btn-play:hover { background: #b20710; }
        
        .btn-down { background: #28a745; text-decoration: none; display: inline-block; }
        .btn-down:hover { background: #1e7e34; }

        pre { background: #000; padding: 15px; border-radius: 4px; overflow-y: auto; max-height: 200px; color: #00ff00; font-family: monospace; }
        
        #playerArea { margin-top: 30px; display: none; }
        
        .player-wrapper {
            position: relative;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8); 
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            padding: 10px;
        }

        #videoPlayer { 
            display: block;
            transition: width 0.3s ease, height 0.3s ease; 
            image-rendering: pixelated; 
        }
        
        /* ğŸ’¡ ì¶”ê°€: ì˜¤ë””ì˜¤ ì „ìš© í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        #audioPlayer {
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            width: 512px;
            margin-top: 20px;
        }

        .scale-btn { background: #444; font-size: 13px; padding: 6px 12px; }
        .scale-btn:hover { background: #666; }

        #resultActions {
            display: none; /* ë³€í™˜ ì™„ë£Œ í›„ í‘œì‹œë¨ */
            margin-top: 20px;
            padding: 15px;
            background: #333;
            border-radius: 8px;
            text-align: center;
        }
    </style>
    
    <script src="coi-serviceworker.min.js"></script>
    
    <script src="ffmpeg.js"></script>
</head>
<body>

    <h1>ğŸ¬ MSX MV2 Web Demuxer (MP4 & MP3)</h1>
    
    <div class="box">
        <input type="file" id="mv2file" accept=".MV2,.mv2" />
        <br><br>
        <button id="startBtn" class="btn-primary">â–¶ ë³€í™˜ ë° ì¶”ì¶œ ì‹œì‘</button>
    </div>

    <div id="resultActions">
        <h3>âœ… ë³€í™˜ ì™„ë£Œ! ì›í•˜ëŠ” ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”</h3>
        <div>
            <button id="playVidBtn" class="btn-play">ğŸ¬ ë¹„ë””ì˜¤(MP4) í™”ë©´ ì¬ìƒ</button>
            <button id="playAudBtn" class="btn-play">ğŸµ ì˜¤ë””ì˜¤(MP3) ë‹¨ë… ì¬ìƒ</button>
        </div>
        <div style="margin-top: 10px;">
            <a id="downVidBtn" class="btn-down">â†“ MP4(ë¹„ë””ì˜¤) ì €ì¥</a>
            <a id="downAudBtn" class="btn-down">â†“ MP3(ì˜¤ë””ì˜¤) ì €ì¥</a>
        </div>
    </div>

    <div id="playerArea">
        <div id="scaleControls" style="margin-bottom: 10px;">
            <button class="scale-btn" id="btn1x">1x (256x192)</button>
            <button class="scale-btn" id="btn2x">2x (512x384)</button>
            <button class="scale-btn" id="btn4x">4x (1024x768)</button>
        </div>
        
        <div class="player-wrapper">
            <video id="videoPlayer" controls playsinline></video>
            <audio id="audioPlayer" controls></audio>
        </div>
    </div>

    <div class="box" style="margin-top: 30px;">
        <h3>ì§„í–‰ ìƒí™© ë¡œê·¸</h3>
        <pre id="log">ëŒ€ê¸° ì¤‘...</pre>
    </div>

    <canvas id="renderCanvas" width="256" height="192" style="display:none;"></canvas>

    <script>
        const { FFmpeg } = FFmpegWASM;
        const ffmpeg = new FFmpeg();
        
        // DOM ìš”ì†Œ ìºì‹±
        const logEl = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const resultActions = document.getElementById('resultActions');
        const playerArea = document.getElementById('playerArea');
        const videoPlayer = document.getElementById('videoPlayer');
        const audioPlayer = document.getElementById('audioPlayer');
        const scaleControls = document.getElementById('scaleControls');
        
        const playVidBtn = document.getElementById('playVidBtn');
        const playAudBtn = document.getElementById('playAudBtn');
        const downVidBtn = document.getElementById('downVidBtn');
        const downAudBtn = document.getElementById('downAudBtn');
        
        const renderCanvas = document.getElementById('renderCanvas');
        const ctx = renderCanvas.getContext('2d', { willReadFrequently: true });

        // ìŠ¤ì¼€ì¼ ì¡°ì ˆ ê¸°ëŠ¥ (ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì—ë§Œ ìœ íš¨)
        document.getElementById('btn1x').addEventListener('click', () => setPlayerSize(256, 192));
        document.getElementById('btn2x').addEventListener('click', () => setPlayerSize(512, 384));
        document.getElementById('btn4x').addEventListener('click', () => setPlayerSize(1024, 768));

        function setPlayerSize(w, h) {
            videoPlayer.style.width = w + 'px';
            videoPlayer.style.height = h + 'px';
        }

        function log(msg) {
            logEl.textContent += `\n[System] ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        ffmpeg.on('log', ({ message }) => {
            logEl.textContent += `\n[FFmpeg] ${message}`;
            logEl.scrollTop = logEl.scrollHeight;
        });

        function rgb333_to_888(r, g, b) {
            return [Math.floor(r * 255 / 7), Math.floor(g * 255 / 7), Math.floor(b * 255 / 7)];
        }

        // MV2 íŒŒì¼ ë¶„í•´ (ë¹„ë””ì˜¤ í”„ë ˆì„ + ì˜¤ë””ì˜¤ ì²­í¬ ì¶”ì¶œ)
        async function demuxMV2(arrayBuffer) {
            const data = new Uint8Array(arrayBuffer);
            const blockSize = 16384;
            let remainingBytes = data.length - blockSize;
            let numBlocks = 1 + Math.floor(remainingBytes / 16384);

            const frames = []; 
            let audioChunks = [];
            let palette = Array(16).fill([0, 0, 0]);

            let pos = 16384; 
            let count = 0;

            while (pos < data.length) {
                let currentBlockSize = 16384;
                if (pos + currentBlockSize > data.length) break;

                let block = data.subarray(pos, pos + currentBlockSize);
                pos += currentBlockSize;

                if (block.length < 12318) break;

                for (let i = 0; i < 15; i++) {
                    let b1 = block[12288 + i * 2], b2 = block[12288 + i * 2 + 1];
                    let r = (b1 >> 4) & 0x07, b = b1 & 0x07, g = b2 & 0x07;
                    palette[i + 1] = rgb333_to_888(r, g, b);
                }

                let framePixels = new Uint8Array(256 * 192 * 3);
                let pOffset = 0;
                for (let y = 0; y < 192; y++) {
                    for (let x = 0; x < 256; x++) {
                        let b_idx = Math.floor(y / 8) * 32 + Math.floor(x / 8);
                        let off = b_idx * 8 + (y % 8);
                        let p_byte = block[off], c_byte = block[6144 + off];
                        let fg = c_byte >> 4, bg = c_byte & 0x0F;
                        
                        let isFg = (p_byte & (1 << (7 - (x % 8)))) !== 0;
                        let color = isFg ? palette[fg] : palette[bg];

                        framePixels[pOffset++] = color[0];
                        framePixels[pOffset++] = color[1];
                        framePixels[pOffset++] = color[2];
                    }
                }

                let eqData = new Uint8Array(9);
                for(let i=0; i<9; i++) {
                    eqData[i] = 15 - Math.min(block[12320 + i], 15);
                }

                frames.push({ pixels: framePixels, eq: eqData });

                if (block.length > 12800) {
                    let sizeIndicator = block[12800];
                    if (sizeIndicator > 0 && sizeIndicator <= 128) {
                        let chunkSize = sizeIndicator * 32;
                        if (12801 + chunkSize <= block.length) {
                            audioChunks.push(block.slice(12801, 12801 + chunkSize));
                        }
                    }
                }
                
                if (count % 100 === 0) log(`MV2 íŒŒì‹± ì¤‘... ${count}/${numBlocks}`);
                count++;
            }

            let totalAudioLength = audioChunks.reduce((acc, val) => acc + val.length, 0);
            let audioBuffer = new Uint8Array(totalAudioLength);
            let aOff = 0;
            for (let chunk of audioChunks) {
                audioBuffer.set(chunk, aOff);
                aOff += chunk.length;
            }

            return { frames, audioBuffer };
        }

        // ë¹„ë””ì˜¤ + ë°˜íˆ¬ëª… EQ ì˜¤ë²„ë ˆì´ ìº”ë²„ìŠ¤ í•©ì„±
        function generateVideoWithEQ(frames) {
            const numFrames = frames.length;
            const finalVideoBuffer = new Uint8Array(numFrames * 256 * 192 * 3);
            let offset = 0;

            const eqWidth = 256 * 0.25;  
            const eqHeight = 192 * 0.25; 
            const maxBarHeight = eqHeight * 0.9; 
            const barWidth = Math.floor(eqWidth / 9) - 1;

            log(`ìº”ë²„ìŠ¤ì— ì˜¤ë²„ë ˆì´ í•©ì„± ì¤‘... ì´ ${numFrames} í”„ë ˆì„`);

            for (let f = 0; f < numFrames; f++) {
                const frameData = frames[f];
                
                const imgData = ctx.createImageData(256, 192);
                let pIdx = 0;
                for (let i = 0; i < frameData.pixels.length; i += 3) {
                    imgData.data[pIdx++] = frameData.pixels[i];     
                    imgData.data[pIdx++] = frameData.pixels[i+1];   
                    imgData.data[pIdx++] = frameData.pixels[i+2];   
                    imgData.data[pIdx++] = 255;                     
                }
                
                ctx.putImageData(imgData, 0, 0);

                ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
                for (let b = 0; b < 9; b++) {
                    const eqVal = frameData.eq[b]; 
                    const height = (eqVal / 15.0) * maxBarHeight;
                    const x = 2 + b * (barWidth + 1);
                    const y = eqHeight - height + 2; 
                    ctx.fillRect(x, y, barWidth, Math.max(1, height));
                }

                const compositedData = ctx.getImageData(0, 0, 256, 192).data;
                for (let i = 0; i < compositedData.length; i += 4) {
                    finalVideoBuffer[offset++] = compositedData[i];     
                    finalVideoBuffer[offset++] = compositedData[i+1];   
                    finalVideoBuffer[offset++] = compositedData[i+2];   
                }
                
                if (f % 100 === 0) log(`í•©ì„± ì§„í–‰ë¥ : ${Math.round((f/numFrames)*100)}%`);
            }
            
            return finalVideoBuffer;
        }

        // ğŸ’¡ í”Œë ˆì´ì–´ ì „í™˜ ë¡œì§ (ë¹„ë””ì˜¤ vs ì˜¤ë””ì˜¤)
        function switchPlayer(type) {
            playerArea.style.display = "block";
            
            if (type === 'video') {
                audioPlayer.pause();
                audioPlayer.style.display = "none";
                videoPlayer.style.display = "block";
                scaleControls.style.display = "block";
                videoPlayer.play().catch(e => console.warn("ìë™ì¬ìƒ ì°¨ë‹¨:", e));
            } else {
                videoPlayer.pause();
                videoPlayer.style.display = "none";
                scaleControls.style.display = "none";
                audioPlayer.style.display = "block";
                audioPlayer.play().catch(e => console.warn("ìë™ì¬ìƒ ì°¨ë‹¨:", e));
            }
        }

        startBtn.addEventListener('click', async () => {
            const fileInput = document.getElementById('mv2file');
            if (!fileInput.files.length) {
                alert("MV2 íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            // ì´ˆê¸°í™”
            startBtn.disabled = true;
            resultActions.style.display = "none";
            playerArea.style.display = "none";
            videoPlayer.pause();
            audioPlayer.pause();
            
            logEl.textContent = "ë³€í™˜ ì¤€ë¹„ ì¤‘...";

            try {
                const file = fileInput.files[0];
                const baseFileName = file.name.replace(/\.[^/.]+$/, "");
                const arrayBuffer = await file.arrayBuffer();

                log("1. MV2 íŒŒì¼ íŒŒì‹± ë° ë°ì´í„° ì¶”ì¶œ ì¤‘...");
                const { frames, audioBuffer } = await demuxMV2(arrayBuffer);

                log("2. ë¹„ë””ì˜¤ í”„ë ˆì„ì— EQ ì˜¤ë²„ë ˆì´ í•©ì„± ì¤‘...");
                const videoBuffer = generateVideoWithEQ(frames);

                log("3. FFmpeg.wasm ë¡œë“œ ì¤‘...");
                if (!ffmpeg.loaded) {
                    await ffmpeg.load({
                        coreURL: 'ffmpeg-core.js',
                        wasmURL: 'ffmpeg-core.wasm'
                    });
                }

                log("4. ê°€ìƒ íŒŒì¼ ì‹œìŠ¤í…œ(MEMFS)ì— ê¸°ë¡ ì¤‘...");
                await ffmpeg.writeFile('video.raw', videoBuffer);
                await ffmpeg.writeFile('audio.mp3', audioBuffer); // ì¶”ì¶œëœ ìˆœìˆ˜ ì›ë³¸ ì˜¤ë””ì˜¤ ë³´ê´€

                log("5. Muxing ë° ALAC ì˜¤ë””ì˜¤ ì¸ì½”ë”© ì‹œì‘...");
                await ffmpeg.exec([
                    '-y',
                    '-f', 'rawvideo',
                    '-pix_fmt', 'rgb24',
                    '-s', '256x192',
                    '-r', '15',
                    '-i', 'video.raw',
                    '-i', 'audio.mp3',
                    '-c:v', 'libx264',
                    '-pix_fmt', 'yuv420p',
                    '-c:a', 'alac',
                    '-shortest',
                    'output.mp4' 
                ]);

                log("6. íŒŒì¼ ìƒì„± ì™„ë£Œ! ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.");
                
                // ğŸ’¡ í•µì‹¬ ë¡œì§: MP4ì™€ MP3ë¥¼ ê°ê° ë…ë¦½ì ìœ¼ë¡œ ì½ì–´ì™€(Read) Blobê³¼ URLì„ ìƒì„±í•©ë‹ˆë‹¤.
                
                // [A] ë¹„ë””ì˜¤(MP4) ë°ì´í„° ì²˜ë¦¬
                const mp4Data = await ffmpeg.readFile('output.mp4');
                const mp4Blob = new Blob([mp4Data.buffer], { type: 'video/mp4' });
                const mp4Url = URL.createObjectURL(mp4Blob);
                
                // [B] ì˜¤ë””ì˜¤(MP3) ë°ì´í„° ì²˜ë¦¬ (ì›ë³¸ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜´)
                const mp3Data = await ffmpeg.readFile('audio.mp3');
                const mp3Blob = new Blob([mp3Data.buffer], { type: 'audio/mpeg' });
                const mp3Url = URL.createObjectURL(mp3Blob);
                
                // í”Œë ˆì´ì–´ì— ì†ŒìŠ¤ í• ë‹¹
                videoPlayer.src = mp4Url;
                audioPlayer.src = mp3Url;
                setPlayerSize(512, 384); // ê¸°ë³¸ 2x í¬ê¸°ë¡œ ì§€ì •
                
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì— ì†ŒìŠ¤ ë° íŒŒì¼ëª… í• ë‹¹
                downVidBtn.href = mp4Url;
                downVidBtn.download = `${baseFileName}_video.mp4`;
                
                downAudBtn.href = mp3Url;
                downAudBtn.download = `${baseFileName}_audio.mp3`;

                // ë³€í™˜ ì™„ë£Œ í›„ ì•¡ì…˜ íŒ¨ë„ í‘œì‹œ
                resultActions.style.display = "block";
                
                // ê°€ìƒ ë©”ëª¨ë¦¬ í™•ë³´ë¥¼ ìœ„í•œ ì •ë¦¬
                ffmpeg.deleteFile('video.raw');
                ffmpeg.deleteFile('audio.mp3');
                ffmpeg.deleteFile('output.mp4');
                
                log("âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ! ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì¸í•´ ë³´ì„¸ìš”.");

            } catch (error) {
                log(`âŒ ì—ëŸ¬ ë°œìƒ: ${error.message}`);
                console.error(error);
            } finally {
                startBtn.disabled = false;
            }
        });

        // ì„ íƒ ì¬ìƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        playVidBtn.addEventListener('click', () => switchPlayer('video'));
        playAudBtn.addEventListener('click', () => switchPlayer('audio'));
    </script>
</body>
</html>
