<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MSX MV2 to MP4 (ALAC & EQ Overlay) Web Demuxer</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #1e1e1e; color: #fff; padding: 40px; max-width: 1200px; margin: 0 auto; text-align: center; }
        .box { background: #2d2d2d; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-align: left; }
        button { background: #0078D7; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; margin-right: 5px; }
        button:hover { background: #005a9e; }
        button:disabled { background: #555; cursor: not-allowed; }
        pre { background: #000; padding: 15px; border-radius: 4px; overflow-y: auto; max-height: 200px; color: #00ff00; font-family: monospace; }
        #downloadBtn { display: inline-block; background: #28a745; text-decoration: none; color: white; padding: 10px 20px; border-radius: 4px; display: none; margin-top: 10px; }
        
        #playerArea { margin-top: 30px; display: none; }
        
        .player-wrapper {
            position: relative;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8); 
        }

        #player { 
            background: #000; 
            display: block;
            transition: width 0.3s ease, height 0.3s ease; 
            image-rendering: pixelated; 
        }
        
        .scale-btn { background: #444; font-size: 14px; padding: 6px 15px; }
        .scale-btn:hover { background: #666; }

        .unmute-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            z-index: 10;
            margin: 0;
        }

        .unmute-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .fade-out {
            opacity: 0;
            visibility: hidden;
            transform: scale(0.9);
        }
    </style>
    <script src="coi-serviceworker.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.js"></script>
</head>
<body>

    <h1>ğŸ¬ MSX MV2 Web Demuxer (ALAC + EQ Overlay)</h1>
    <div class="box">
        <input type="file" id="mv2file" accept=".MV2,.mv2" />
        <br>
        <button id="startBtn">ë³€í™˜ ë° ì¬ìƒ ì‹œì‘</button>
        <a id="downloadBtn" download="output.mp4">â†“ MP4(ALAC) ì €ì¥í•˜ê¸°</a>
    </div>

    <div id="playerArea">
        <div>
            <button class="scale-btn" id="btn1x">1x (256x192)</button>
            <button class="scale-btn" id="btn2x">2x (512x384)</button>
            <button class="scale-btn" id="btn4x">4x (1024x768)</button>
        </div>
        <br>
        <div class="player-wrapper">
            <video id="player" controls autoplay muted playsinline></video>
            <button id="unmuteBtn" class="unmute-btn">ì†Œë¦¬ ì¼œê¸°</button>
        </div>
    </div>

    <div class="box" style="margin-top: 30px;">
        <h3>ì§„í–‰ ìƒí™© ë¡œê·¸</h3>
        <pre id="log">ëŒ€ê¸° ì¤‘...</pre>
    </div>

    <canvas id="renderCanvas" width="256" height="192" style="display:none;"></canvas>

    <script>
        const { FFmpeg } = FFmpegWASM;
        const ffmpeg = new FFmpeg();
        const logEl = document.getElementById('log');
        const startBtn = document.getElementById('startBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const playerArea = document.getElementById('playerArea');
        const player = document.getElementById('player');
        const unmuteBtn = document.getElementById('unmuteBtn');
        const renderCanvas = document.getElementById('renderCanvas');
        const ctx = renderCanvas.getContext('2d', { willReadFrequently: true });

        unmuteBtn.addEventListener('click', () => {
            player.muted = false;
            player.play().catch(e => console.error("ì¬ìƒ ì—ëŸ¬:", e));
            unmuteBtn.classList.add('fade-out');
        });

        document.getElementById('btn1x').addEventListener('click', () => setPlayerSize(256, 192));
        document.getElementById('btn2x').addEventListener('click', () => setPlayerSize(512, 384));
        document.getElementById('btn4x').addEventListener('click', () => setPlayerSize(1024, 768));

        function setPlayerSize(w, h) {
            player.style.width = w + 'px';
            player.style.height = h + 'px';
        }

        function log(msg) {
            logEl.textContent += `\n[System] ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        ffmpeg.on('log', ({ message }) => {
            logEl.textContent += `\n[FFmpeg] ${message}`;
            logEl.scrollTop = logEl.scrollHeight;
        });

        function rgb333_to_888(r, g, b) {
            return [Math.floor(r * 255 / 7), Math.floor(g * 255 / 7), Math.floor(b * 255 / 7)];
        }

        // ğŸ’¡ ìˆ˜ì •ëœ demux í•¨ìˆ˜: EQ ë°ì´í„°ë„ í•¨ê»˜ ì¶”ì¶œí•©ë‹ˆë‹¤.
        async function demuxMV2(arrayBuffer) {
            const data = new Uint8Array(arrayBuffer);
            const blockSize = 16384;
            let remainingBytes = data.length - blockSize;
            let numBlocks = 1 + Math.floor(remainingBytes / 16384);

            const frames = []; // í”„ë ˆì„ ë‹¨ìœ„ ë°ì´í„°(í”½ì…€ + EQ) ì €ì¥ ë°°ì—´
            let audioChunks = [];
            let palette = Array(16).fill([0, 0, 0]);

            let pos = 16384; // ì²« ë²ˆì§¸ 16KB í—¤ë” ê±´ë„ˆëœ€
            let count = 0;

            while (pos < data.length) {
                let currentBlockSize = 16384;
                if (pos + currentBlockSize > data.length) break;

                let block = data.subarray(pos, pos + currentBlockSize);
                pos += currentBlockSize;

                if (block.length < 12318) break;

                // 1. íŒ”ë ˆíŠ¸ ì¶”ì¶œ
                for (let i = 0; i < 15; i++) {
                    let b1 = block[12288 + i * 2], b2 = block[12288 + i * 2 + 1];
                    let r = (b1 >> 4) & 0x07, b = b1 & 0x07, g = b2 & 0x07;
                    palette[i + 1] = rgb333_to_888(r, g, b);
                }

                // 2. ë¹„ë””ì˜¤ í”½ì…€ ì¶”ì¶œ
                let framePixels = new Uint8Array(256 * 192 * 3);
                let pOffset = 0;
                for (let y = 0; y < 192; y++) {
                    for (let x = 0; x < 256; x++) {
                        let b_idx = Math.floor(y / 8) * 32 + Math.floor(x / 8);
                        let off = b_idx * 8 + (y % 8);
                        let p_byte = block[off], c_byte = block[6144 + off];
                        let fg = c_byte >> 4, bg = c_byte & 0x0F;
                        
                        let isFg = (p_byte & (1 << (7 - (x % 8)))) !== 0;
                        let color = isFg ? palette[fg] : palette[bg];

                        framePixels[pOffset++] = color[0];
                        framePixels[pOffset++] = color[1];
                        framePixels[pOffset++] = color[2];
                    }
                }

                // ğŸ’¡ 3. EQ ë°ì´í„° ì¶”ì¶œ (ì˜¤í”„ì…‹ 12320ì—ì„œ 9ë°”ì´íŠ¸)
                let eqData = new Uint8Array(9);
                for(let i=0; i<9; i++) {
                    // ê°’ ë°˜ì „ ë³µì› ë¡œì§ í¬í•¨ (0ì´ ìµœì†Œ, 15ê°€ ìµœëŒ€ ë†’ì´ê°€ ë˜ë„ë¡)
                    eqData[i] = 15 - Math.min(block[12320 + i], 15);
                }

                frames.push({ pixels: framePixels, eq: eqData });

                // 4. ì˜¤ë””ì˜¤ ì¶”ì¶œ
                if (block.length > 12800) {
                    let sizeIndicator = block[12800];
                    if (sizeIndicator > 0 && sizeIndicator <= 128) {
                        let chunkSize = sizeIndicator * 32;
                        if (12801 + chunkSize <= block.length) {
                            audioChunks.push(block.slice(12801, 12801 + chunkSize));
                        }
                    }
                }
                
                if (count % 100 === 0) log(`MV2 íŒŒì‹± ì¤‘... ${count}/${numBlocks}`);
                count++;
            }

            let totalAudioLength = audioChunks.reduce((acc, val) => acc + val.length, 0);
            let audioBuffer = new Uint8Array(totalAudioLength);
            let aOff = 0;
            for (let chunk of audioChunks) {
                audioBuffer.set(chunk, aOff);
                aOff += chunk.length;
            }

            return { frames, audioBuffer };
        }

        // ğŸ’¡ ìº”ë²„ìŠ¤ì— ë¹„ë””ì˜¤ í”½ì…€ê³¼ ë°˜íˆ¬ëª… EQë¥¼ í•©ì„±í•˜ì—¬ ìµœì¢… Raw ìŠ¤íŠ¸ë¦¼ ìƒì„±
        function generateVideoWithEQ(frames) {
            const numFrames = frames.length;
            // 256 * 192 * 3 (RGB) ë°”ì´íŠ¸ ë°°ì—´
            const finalVideoBuffer = new Uint8Array(numFrames * 256 * 192 * 3);
            let offset = 0;

            // ì˜¤ë²„ë ˆì´ ì„¤ì • (ê°€ë¡œì„¸ë¡œ 1/4 í¬ê¸° = ë©´ì  1/16, ì¢Œìƒë‹¨ ë°°ì¹˜)
            const eqWidth = 256 * 0.25;  // 64px
            const eqHeight = 192 * 0.25; // 48px
            const maxBarHeight = eqHeight * 0.9; // íŒ¨ë”© ì—¬ìœ ë¶„
            const barWidth = Math.floor(eqWidth / 9) - 1;

            log(`ìº”ë²„ìŠ¤ì— ì˜¤ë²„ë ˆì´ í•©ì„± ì¤‘... ì´ ${numFrames} í”„ë ˆì„`);

            for (let f = 0; f < numFrames; f++) {
                const frameData = frames[f];
                
                // 1. í”½ì…€ ë°ì´í„°ë¥¼ ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ ë°ì´í„°ë¡œ ë³€í™˜
                const imgData = ctx.createImageData(256, 192);
                let pIdx = 0;
                for (let i = 0; i < frameData.pixels.length; i += 3) {
                    imgData.data[pIdx++] = frameData.pixels[i];     // R
                    imgData.data[pIdx++] = frameData.pixels[i+1];   // G
                    imgData.data[pIdx++] = frameData.pixels[i+2];   // B
                    imgData.data[pIdx++] = 255;                     // A (ë¶ˆíˆ¬ëª…)
                }
                
                // 2. ìº”ë²„ìŠ¤ì— ë¹„ë””ì˜¤ í”„ë ˆì„ ë Œë”ë§
                ctx.putImageData(imgData, 0, 0);

                // 3. EQ ì˜¤ë²„ë ˆì´ ê·¸ë¦¬ê¸° (20% ë°±ìƒ‰ ë°˜íˆ¬ëª…)
                ctx.fillStyle = "rgba(255, 255, 255, 0.2)";
                for (let b = 0; b < 9; b++) {
                    const eqVal = frameData.eq[b]; // 0 ~ 15
                    const height = (eqVal / 15.0) * maxBarHeight;
                    
                    // í•˜ë‹¨ ì •ë ¬ì„ ìœ„í•œ Y ì¢Œí‘œ ê³„ì‚° (ì—¬ë°± 2px ì¶”ê°€)
                    const x = 2 + b * (barWidth + 1);
                    const y = eqHeight - height + 2; 
                    
                    // ìµœì†Œ ë†’ì´ 1px ë³´ì¥
                    ctx.fillRect(x, y, barWidth, Math.max(1, height));
                }

                // 4. í•©ì„±ëœ ìº”ë²„ìŠ¤ í”½ì…€ì„ ë‹¤ì‹œ Raw RGB ë°°ì—´ë¡œ ì¶”ì¶œ
                const compositedData = ctx.getImageData(0, 0, 256, 192).data;
                for (let i = 0; i < compositedData.length; i += 4) {
                    finalVideoBuffer[offset++] = compositedData[i];     // R
                    finalVideoBuffer[offset++] = compositedData[i+1];   // G
                    finalVideoBuffer[offset++] = compositedData[i+2];   // B
                }
                
                if (f % 100 === 0) log(`í•©ì„± ì§„í–‰ë¥ : ${Math.round((f/numFrames)*100)}%`);
            }
            
            return finalVideoBuffer;
        }

        startBtn.addEventListener('click', async () => {
            const fileInput = document.getElementById('mv2file');
            if (!fileInput.files.length) {
                alert("MV2 íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            startBtn.disabled = true;
            downloadBtn.style.display = "none";
            playerArea.style.display = "none";
            
            player.pause();
            player.muted = true; 
            unmuteBtn.classList.remove('fade-out');
            
            logEl.textContent = "ë³€í™˜ ì¤€ë¹„ ì¤‘...";

            try {
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();

                log("1. MV2 íŒŒì¼ íŒŒì‹± ë° ë°ì´í„° ì¶”ì¶œ ì¤‘...");
                const { frames, audioBuffer } = await demuxMV2(arrayBuffer);

                log("2. ë¹„ë””ì˜¤ í”„ë ˆì„ì— EQ ì˜¤ë²„ë ˆì´ í•©ì„± ì¤‘...");
                const videoBuffer = generateVideoWithEQ(frames);

                log("3. FFmpeg.wasm ë¡œë“œ ì¤‘...");
                if (!ffmpeg.loaded) {
                    await ffmpeg.load({
                        coreURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.js',
                        wasmURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/umd/ffmpeg-core.wasm'
                    });
                }

                log("4. ê°€ìƒ íŒŒì¼ ì‹œìŠ¤í…œ(MEMFS)ì— ê¸°ë¡ ì¤‘...");
                await ffmpeg.writeFile('video.raw', videoBuffer);
                await ffmpeg.writeFile('audio.mp3', audioBuffer); // ì¶”ì¶œëœ ì›ë³¸ ì˜¤ë””ì˜¤

                log("5. Muxing ë° ALAC ì˜¤ë””ì˜¤ ì¸ì½”ë”© ì‹œì‘...");
                // ğŸ’¡ ì˜¤ë””ì˜¤ ì½”ë±ì„ alacìœ¼ë¡œ ì§€ì •í•˜ì—¬ ë³€í™˜
                await ffmpeg.exec([
                    '-y',
                    '-f', 'rawvideo',
                    '-pix_fmt', 'rgb24',
                    '-s', '256x192',
                    '-r', '15',
                    '-i', 'video.raw',
                    '-i', 'audio.mp3',
                    '-c:v', 'libx264',
                    '-pix_fmt', 'yuv420p',
                    '-c:a', 'alac', // MP3 -> ALAC ë¬´ì†ì‹¤ ë³€í™˜
                    '-shortest',
                    'output.mp4' // ALACì€ MP4/M4A ì»¨í…Œì´ë„ˆì—ì„œ ì •ìƒ ì‘ë™
                ]);

                log("6. ë³€í™˜ ì™„ë£Œ! ì¬ìƒ ë° ë‹¤ìš´ë¡œë“œë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.");
                
                const data = await ffmpeg.readFile('output.mp4');
                const blob = new Blob([data.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                
                player.src = url;
                setPlayerSize(512, 384);  
                playerArea.style.display = "block";
                
                player.play().catch(e => log(`ìë™ ì¬ìƒ ì •ì±… ì°¨ë‹¨: ${e}`));
                
                downloadBtn.href = url;
                downloadBtn.download = file.name.replace(/\.[^/.]+$/, "") + "_alac_eq.mp4";
                downloadBtn.style.display = "inline-block";
                
                ffmpeg.deleteFile('video.raw');
                ffmpeg.deleteFile('audio.mp3');
                ffmpeg.deleteFile('output.mp4');

            } catch (error) {
                log(`âŒ ì—ëŸ¬ ë°œìƒ: ${error.message}`);
                console.error(error);
            } finally {
                startBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
